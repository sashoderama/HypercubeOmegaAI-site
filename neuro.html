<!DOCTYPE html>
<html lang="en" data-theme="aurora-dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0d1117" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="description" content="AuroraGenesis-OMEGA: Advanced AI Cybersecurity System." />
  <meta name="keywords" content="AI, cybersecurity, AGI, forensic, memory compression, dual-GPU" />
  <meta name="author" content="xAI" />
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' http://127.0.0.1:8000;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com;
    img-src * data:;
    font-src 'self' https://fonts.gstatic.com;
    connect-src *;
    worker-src 'self';
  " />
  <title>AuroraGenesis-OMEGA</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" />
  <style>
    :root {
      --bg-main: #0d1117;
      --bg-panel: #161b22;
      --bg-glass: rgba(255, 255, 255, 0.03);
      --text-main: #d0d6e0;
      --text-muted: #7a8594;
      --accent: #2f81f7;
      --border: #2c313c;
      --radius: 12px;
      --blur: blur(14px);
      --glow: 0 0 40px rgba(47, 129, 247, 0.25);
      --transition: all 0.3s ease-in-out;
      --vh: 1vh;
    }

    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      background: var(--bg-main);
      font-family: 'Inter', sans-serif;
      color: var(--text-main);
      overflow: hidden;
    }

    body.loaded {
      overflow: auto;
    }

    .background-aurora {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(ellipse at center, rgba(47,129,247,0.05), transparent 70%),
        linear-gradient(to bottom, #0d1117 0%, #161b22 100%);
      z-index: -10;
      pointer-events: none;
    }

    .main-wrapper {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 2rem clamp(1rem, 5vw, 4rem);
      gap: 2rem;
    }

    .frost-container {
      background: var(--bg-glass);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--glow);
      padding: 2rem;
      backdrop-filter: var(--blur);
      display: flex;
      flex-direction: column;
      gap: 2rem;
      height: 80vh;
      overflow: hidden;
    }

    .chat-log {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      scroll-behavior: smooth;
      padding-right: 0.5rem;
    }

    .chat-log::-webkit-scrollbar {
      width: 8px;
    }

    .chat-log::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 4px;
    }

    .message-bubble {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      box-shadow: var(--glow);
      max-width: 80%;
      opacity: 0;
      transform: translateY(20px);
      animation: bubbleIn 0.4s ease forwards;
    }

    @keyframes bubbleIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-bubble.user {
      align-self: flex-end;
      background: #1f6feb;
    }

    .message-bubble.ai {
      align-self: flex-start;
      background: var(--bg-panel);
    }

    .input-group {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .chat-input {
      flex: 1;
      padding: 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg-panel);
      color: var(--text-main);
      font-size: 1rem;
    }

    .control-button {
      padding: 1rem 1.4rem;
      background: var(--accent);
      border: none;
      color: #fff;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .control-button:hover {
      background: #1a5cd8;
    }

    .loader {
      display: none;
      width: 28px;
      height: 28px;
      border: 4px solid var(--accent);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loader.active {
      display: inline-block;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body class="main-wrapper">
  <!-- Background FX -->
  <div class="background-aurora"></div>

  <!-- Preloader -->
  <div id="preloader" style="
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:var(--bg-main);display:flex;align-items:center;
    justify-content:center;z-index:9999;">
    <div style="
      width:100px;height:100px;border:8px solid var(--accent);
      border-top-color:transparent;border-radius:50%;
      animation:spin 1s linear infinite;"></div>
  </div>

  <!-- MAIN INTERFACE -->
  <div class="frost-container">
    <!-- CHAT LOG -->
    <div class="chat-log" id="chatLog" role="log" aria-live="polite"></div>

    <!-- INPUT -->
    <div class="input-group">
      <input id="chat-input" type="text" class="chat-input" placeholder="Ask AuroraGenesis anythingâ€¦" />
      <button class="control-button" id="send-button">Send</button>
      <div id="loader" class="loader"></div>
    </div>
  </div>

  <!-- ASSISTANT -->
  <div id="proChat-root" class="hidden" style="
    position:fixed;bottom:5.5rem;right:1.5rem;z-index:1000;
    transition:var(--transition);opacity:0;pointer-events:none;">
    <div class="proChat-frame" style="
      width:360px;height:480px;display:flex;flex-direction:column;
      background:var(--bg-panel);border-radius:var(--radius);
      border:1px solid var(--border);box-shadow:var(--glow);
      overflow:hidden;backdrop-filter:var(--blur);">
      <header class="proChat-header" style="
        padding:1rem;border-bottom:1px solid var(--border);
        display:flex;justify-content:space-between;align-items:center;">
        <span style="font-weight:600">Aurora Assistant</span>
        <button id="proChat-close" aria-label="Close chat" style="
          background:none;border:none;color:var(--text-muted);
          font-size:1.4rem;cursor:pointer;">Ã—</button>
      </header>
      <ul id="proChat-log" class="proChat-log" style="
        flex:1;overflow-y:auto;padding:1rem;
        font-size:0.95rem;"></ul>
      <form id="proChat-form" class="proChat-inputRow" style="
        display:flex;padding:0.8rem;border-top:1px solid var(--border);">
        <input id="proChat-input" type="text" placeholder="Type a messageâ€¦" style="
          flex:1;padding:0.6rem 1rem;border-radius:var(--radius);
          background:var(--bg-panel);border:1px solid var(--border);
          color:var(--text-main);outline:none;" />
        <button type="submit" style="
          width:48px;margin-left:0.6rem;border-radius:var(--radius);
          background:var(--accent);color:white;border:none;
          font-size:1.1rem;cursor:pointer;">â®ž</button>
      </form>
    </div>
  </div>

  <!-- ASSISTANT TOGGLE -->
  <button id="proChat-launcher" aria-label="Launch Aurora Assistant" class="proChat-launcher" style="
    position:fixed;bottom:1.5rem;right:1.5rem;width:56px;height:56px;
    border-radius:50%;background:var(--accent);color:white;
    border:none;font-size:1.6rem;cursor:pointer;box-shadow:var(--glow);
    z-index:999;">ðŸ’¬</button>

  <!-- TOAST -->
  <div id="toast" class="toast" style="
    display:none;position:fixed;bottom:2rem;left:50%;
    transform:translateX(-50%);padding:1rem 2rem;
    background:var(--bg-panel);border:1px solid var(--border);
    color:var(--text-main);border-radius:var(--radius);
    z-index:2000;"></div>

  <script>
    // Auto-load setup
    window.addEventListener('load', () => {
      document.getElementById('preloader').style.display = 'none';
      document.body.classList.add('loaded');
    });

    // Chat launcher logic
    const launcher = document.getElementById('proChat-launcher');
    const root = document.getElementById('proChat-root');
    const closeBtn = document.getElementById('proChat-close');

    launcher.onclick = () => {
      root.classList.remove('hidden');
      root.style.opacity = 1;
      root.style.pointerEvents = 'auto';
      document.getElementById('proChat-input').focus();
    };

    closeBtn.onclick = () => {
      root.style.opacity = 0;
      root.style.pointerEvents = 'none';
      setTimeout(() => root.classList.add('hidden'), 300);
    };
  </script>
<script type="module">
  const chatLog = document.getElementById('chatLog');
  const inputEl = document.getElementById('chat-input');
  const sendBtn = document.getElementById('send-button');
  const loader = document.getElementById('loader');
  const HF_MODEL = 'NousResearch/Hermes-2-Pro-Mistral-7B';
  const HF_TOKEN = document.querySelector('meta[name=HUGGINGFACE_TOKEN]')?.content || '';

  let sessionMemory = JSON.parse(localStorage.getItem('aurora-session') || '[]');

  const scrollDown = () => chatLog.scrollTo({ top: chatLog.scrollHeight, behavior: 'smooth' });

  const saveSession = () => {
    const messages = Array.from(chatLog.children).map(el => ({
      text: el.textContent,
      type: el.classList.contains('user') ? 'user' : 'ai'
    }));
    localStorage.setItem('aurora-session', JSON.stringify(messages));
  };

  const showToast = (msg) => {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(() => toast.style.display = 'none', 2500);
  };

  const renderMessage = (text, type = 'ai') => {
    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${type}`;
    bubble.textContent = text;
    chatLog.appendChild(bubble);
    requestAnimationFrame(() => bubble.classList.add('visible'));
    scrollDown();
    saveSession();
  };

  const renderStreamed = () => {
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble ai';
    chatLog.appendChild(bubble);
    bubble.classList.add('visible');
    scrollDown();
    return bubble;
  };

  async function streamHF(prompt, onToken) {
    const url = `https://api-inference.huggingface.co/models/${HF_MODEL}`;
    const contextStr = sessionMemory.slice(-5).map(m =>
      `${m.type === 'user' ? 'User' : 'Bot'}: ${m.text}`).join('\n');

    const payload = {
      inputs: `[CONTEXT]\n${contextStr}\n\nUser: ${prompt}\nBot:`,
      stream: true,
      parameters: { max_new_tokens: 200, temperature: 0.7 }
    };

    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${HF_TOKEN}`,
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-Use-Stream': 'true'
      },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error(`${res.status}: ${res.statusText}`);

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let full = '';

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value, { stream: true });
      chunk.split('\n').forEach(line => {
        if (!line.trim()) return;
        try {
          const parsed = JSON.parse(line);
          const tok = parsed.token?.text || '';
          onToken(tok);
          full += tok;
        } catch (_) {}
      });
    }

    return full.trim();
  }

  async function handleSend() {
    const q = inputEl.value.trim();
    if (!q) return;
    renderMessage(q, 'user');
    inputEl.value = '';
    loader.classList.add('active');
    const streamEl = renderStreamed();

    try {
      const answer = await streamHF(q, tok => {
        streamEl.textContent += tok;
        scrollDown();
      });
      sessionMemory.push({ text: q, type: 'user' }, { text: answer, type: 'ai' });
      saveSession();
    } catch (e) {
      streamEl.textContent = `(error) ${e.message}`;
      showToast('Streaming failed.');
    } finally {
      loader.classList.remove('active');
    }
  }

  sendBtn.onclick = handleSend;
  inputEl.addEventListener('keydown', e => {
    if (e.key === 'Enter') handleSend();
  });

  // Replay session on load
  sessionMemory.forEach(msg => renderMessage(msg.text, msg.type));

  // Scroll auto-adjust on resize
  window.addEventListener('resize', scrollDown);
</script>
